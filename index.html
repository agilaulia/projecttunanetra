<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Doorlock</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <div class="container mt-5" style="margin-top: 50px">
      <h1 class="text-center">Device Control Panel</h1>
      <div id="deviceCards" class="row justify-content-center mt-4"></div>
      <div id="distanceData" class="mt-5">
        <h3 class="text-center">Distance Sensor Data</h3>
        <div class="row justify-content-center mt-4">
          <div class="col-md-6">
            <ul class="list-group">
              <li class="list-group-item">
                Distance ax: <span id="distanceAx">-</span>
              </li>
              <li class="list-group-item">
                Distance ay: <span id="distanceAy">-</span>
              </li>
              <li class="list-group-item">
                Distance az: <span id="distanceAz">-</span>
              </li>
              <li class="list-group-item">
                MQ135 Analog Value: <span id="mq135Analog">-</span>
              </li>
              <li class="list-group-item">
                MQ135 Voltage: <span id="mq135Voltage">-</span>
              </li>
              <li class="list-group-item">
                Acceleration ac: <span id="accelerationAc">-</span>
              </li>
              <li class="list-group-item">
                Acceleration ay: <span id="accelerationAy">-</span>
              </li>
              <li class="list-group-item">
                Acceleration az: <span id="accelerationAz">-</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      import { firebaseConfig } from "./config.js";

      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        console.log("Firebase Admin initialized successfully");

        const conRef = ref(database, "Device/Con");
        const writeRef = ref(database, "Device/Write");

        onValue(ref(database, "Device"), (snapshot) => {
          const data = snapshot.val();
          console.log("Data retrieved from Firebase:", data);

          if (data) {
            const conStatus = data.Con ? "Door is Closed" : "Door is Open";
            const writeStatus = data.Write;

            // Update UI
            const deviceCards = document.getElementById("deviceCards");
            deviceCards.innerHTML = `
                            <div class="center-div" style="display: flex; justify-content: center; align-items: center; margin-top:50px">
                                <div class="card text-center" style="width:35%; height: 150px;">
                                    <div class="card-header" style="font-size: 30px; font-weight: bold; background-color: grey">
                                        Door Condition
                                    </div>
                                    <div class="card-body">
                                        <h4> <p class="card-text">${conStatus}</p> </h4>
                                    </div>
                                </div>
                                <div class="card text-center" style="width:35%; height: 150px;">
                                    <div class="card-header" style="font-size: 30px; font-weight: bold; background-color: grey">
                                        Button to open the door
                                    </div>
                                    <div class="card-body">
                                        <h4>
                                            <button class="btn btn-primary toggle-button" data-status="${writeStatus}">
                                                ${
                                                  writeStatus ? "Open" : "Close"
                                                }
                                            </button>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        `;

            document
              .querySelector(".toggle-button")
              .addEventListener("click", (event) => {
                const currentStatus =
                  event.target.getAttribute("data-status") === "true";
                const newStatus = !currentStatus;

                set(ref(database, "Device/Write"), newStatus);

                event.target.textContent = newStatus ? "Open" : "Close";
                event.target.setAttribute("data-status", newStatus);
              });
          }
        });

        const paths = {
          distanceAx: "Distance/ax",
          distanceAy: "Distance/ay",
          distanceAz: "Distance/az",
          mq135Analog: "Distance/MQ135/analogValue",
          mq135Voltage: "Distance/MQ135/voltage",
          accelerationAc: "Distance/acceleration/ac",
          accelerationAy: "Distance/acceleration/ay",
          accelerationAz: "Distance/acceleration/az",
        };

        Object.entries(paths).forEach(([id, path]) => {
          const element = document.getElementById(id);
          onValue(ref(database, path), (snapshot) => {
            const value = snapshot.val();
            console.log(`${path}:`, value);
            element.textContent = value !== null ? value : "N/A";
          });
        });
      } catch (error) {
        console.error("Firebase initialization error:", error);
      }
    </script>
  </body>
  <footer>
    <div class="footer" style="text-align: center; margin-top: 200px">
      CCIT-FTUI <br />
      <strong
        >Smart Doorlock Projek Semester3 | TI-Internet-based System
        Automation</strong
      >
    </div>
  </footer>
</html>
